# Scripts Architecture

## Current State

### What Happens to GPT-4o Generated Scripts

1. **Generation Flow:**
   - User calls `POST /api/v1/generate` with prompt + duration + aspect_ratio
   - Handler spawns goroutine that calls `ParserService.GenerateScript()`
   - GPT-4o generates structured Script with scenes, audio spec, metadata
   - Script is assigned unique `script_id` and saved to DynamoDB SCRIPTS_TABLE

2. **Script Storage:**
   - **Table:** `omnigen-scripts` (DynamoDB)
   - **Primary Key:** `script_id` (string, UUID)
   - **TTL:** 30 days (auto-expires)
   - **Status:** `"generated"` (no other states currently used)
   - **Attributes:** title, scenes[], audio_spec, metadata, user_id, timestamps

3. **Script Usage:**
   - Script ID stored in Job metadata (`job.Metadata.script_id`)
   - Scenes immediately extracted and used for video generation
   - Script object kept in-memory during generation process
   - No user interaction with script after generation starts

4. **API Exposure:**
   - ❌ No GET endpoint to retrieve scripts
   - ❌ No PUT endpoint to edit scripts
   - ❌ No POST /parse endpoint (removed - was old two-step flow)
   - Scripts are generated and consumed internally only

## Original Design Intent (Deprecated)

The two-step flow was originally:
1. `POST /api/v1/parse` → Generate script → Return script_id
2. User reviews/edits script via GET/PUT `/api/v1/scripts/:id`
3. `POST /api/v1/generate` with script_id → Generate video

This was replaced with single-step:
1. `POST /api/v1/generate` → Generate script + video in one go

## Current Behavior

**Scripts ARE:**
- ✅ Generated by GPT-4o for every video generation request
- ✅ Saved to DynamoDB SCRIPTS_TABLE
- ✅ Referenced in job metadata
- ✅ Used for video generation (scenes extracted)
- ✅ Auto-expired after 30 days

**Scripts ARE NOT:**
- ❌ Exposed via API endpoints
- ❌ Reviewable by users before generation
- ❌ Editable by users
- ❌ Retrievable after job completes

## Future Considerations

**Option A: Remove Script Persistence**
- Stop saving scripts to DynamoDB
- Use Script object in-memory only during generation
- Reduces DynamoDB costs and complexity
- Loses historical record of what GPT-4o generated

**Option B: Add Script Retrieval Endpoint**
- Add `GET /api/v1/jobs/:id/script` to retrieve script for completed jobs
- Useful for debugging ("what did GPT-4o actually generate?")
- Users can see scene breakdowns, prompts, audio specs
- No editing capability (read-only)

**Option C: Keep Current State**
- Scripts saved but never exposed
- Historical record exists in DynamoDB for debugging/analytics
- No user-facing impact
- Minimal cost (~$0.01/month for storage)

## Related Files

- **Service:** `backend/internal/service/parser.go` - GenerateScript(), SaveScript()
- **Adapter:** `backend/internal/adapters/gpt4o_adapter.go` - GPT-4o API calls
- **Prompts:** `backend/internal/prompts/ad_script_prompt.go` - System prompt with constraints
- **Domain:** `backend/internal/domain/script.go` - Script, Scene, AudioSpec structs
- **Handler:** `backend/internal/api/handlers/generate_async.go` - Consumes scripts for generation
- **Infrastructure:** `infrastructure/modules/data/dynamodb.tf` - SCRIPTS_TABLE definition

## DynamoDB Schema (SCRIPTS_TABLE)

```
omnigen-scripts
├── script_id (PK, String) - "script-{uuid}"
├── user_id (String)
├── title (String)
├── total_duration (Number)
├── scenes (List<Map>) - Array of Scene objects
├── audio_spec (Map) - AudioSpec object
├── metadata (Map) - Metadata object
├── status (String) - "generated"
├── created_at (Number) - Unix timestamp
├── updated_at (Number) - Unix timestamp
└── expires_at (Number) - TTL, 30 days from creation
```

No GSIs currently defined.
